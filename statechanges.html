<!DOCTYPE html>
<html>
<head>

<title></title>

<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
<meta name="Keywords" content="x,y" />

<meta name="Description" content="x,y" />

<meta http-equiv="pragma" content="no-cache" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="-1" />
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAIAEBAAAAEAIABoBAAAJgAAACAgAAABACAAqBAAAI4EAAAoAAAAEAAAACAAAAABACAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAA////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AIaDgv+Gg4L/hoOC/4aDgv+Gg4L/hoOC/4aDgv+Gg4L/hoOC/4aDgv////8A////AP///wD///8A////AP///wCGg4L/////AP///wD///8A////AP///wD///8A////AP///wCGg4L/////AP///wD///8A////AP///wD///8AhoOC/////wCGg4L/hoOC/4aDgv+Gg4L/hoOC/4aDgv////8AhoOC/////wD///8A////AP///wD///8A////AIaDgv////8A////AP///wD///8A////AP///wD///8A////AIaDgv////8A////AP///wD///8A////AP///wCGg4L/////AHCMqP9wjKj/cIyo/3CMqP9wjKj/cIyo/////wCGg4L/////AP///wD///8A////AP///wD///8AhoOC/////wBTlsIAU5bCAFOWwgBTlsIAU5bCM1OWwnP///8AhoOC/////wD///8A////AP///wD///8A////AP///wD///8AU5bCBlOWwndTlsLHU5bC+FOWwv1TlsLR////AP///wD///8A////AP///wD///8A////AP///wD///8A////AFOWwvtTlsLuU5bCu1OWwlc2k9cANpPXqjaT19H///8A////AP///wD///8A////AP///wD///8A////AP///wBTlsIGNpPXADaT1wA2k9dINpPX8TaT1+40ktpDH4r2tB+K9hL///8A////AP///wD///8A////AP///wD///8A////ADaT1wY2k9e7NpPX/TaT16AfivYGH4r23R+K9u4tg/WQLoL1mP///wD///8A////AP///wD///8A////AP///wA2k9fuNpPX5zaT1zMfivYGH4r23R+K9uwjiPYXLoL1+S6C9W7///8A////AP///wD///8A////AP///wD///8ANpPXLjaT1wAfivYGH4r22x+K9usfivYSLoL1oC6C9esugvUA////AP///wD///8A////AP///wD///8A////AP///wD///8AH4r2zx+K9usfivYSLoL1DC6C9fwugvVXLoL1AP///wD///8A////AP///wD///8A////AP///wD///8A////AB+K9kgfivYMH4r2AC6C9bEugvXhLoL1AC6C9QD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wAugvXyLoL1SC6C9QAugvUA////AP//AADgBwAA7/cAAOgXAADv9wAA6BcAAO+XAAD4HwAA+E8AAPsDAAD8AQAA/AEAAP0DAAD/AwAA/ycAAP/nAAAoAAAAIAAAAEAAAAABACAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAA////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AhISE/4SEhP+EhIT/hISE/4SEhP+EhIT/hISE/4SEhP+EhIT/hISE/4SEhP+EhIT/hISE/4SEhP+EhIT/hISE/4SEhP+EhIT/hISE/////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wCEhIT/hISE/4SEhP+EhIT/hISE/4SEhP+EhIT/hISE/4SEhP+EhIT/hISE/4SEhP+EhIT/hISE/4SEhP+EhIT/hISE/4SEhP+EhIT/////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AISEhP+EhIT/////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AhISE/4SEhP////8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AhISE/4SEhP////8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wCEhIT/hISE/////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wCEhIT/hISE/////wD///8AhISE/4SEhP+EhIT/hISE/4SEhP+EhIT/hISE/4SEhP+EhIT/hISE/4SEhP8AAAAA////AISEhP+EhIT/////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AISEhP+EhIT/////AP///wCEhIT/hISE/4SEhP+EhIT/hISE/4SEhP+EhIT/hISE/4SEhP+EhIT/hISE/wAAAAD///8AhISE/4SEhP////8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AhISE/4SEhP/4+vsA4ujuAOLo7gDi6O4A4ujuAN3k6wDZ4OgA2eDoANng6ADZ4OgA2eDoANng6ADW3uYAJS84APj6+wCEhIT/hISE/////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wCEhIT/hISE/9Xd5QBwjKgAcIyoRnCMqGRwjKhxcIyogHCMqI9wjKidcIyoq3CMqLlwjKjHcIyo1HCMqLhogpwA/f7+AISEhP+EhIT/////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AISEhP+EhIT/xtHcAHCMqABwjKjAcIyo/3CMqP9wjKj/cIyo/3CMqP9wjKj/cIyo/3CMqP9wjKj/cIyo4EdZawD///8AhISE/4SEhP////8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AhISE/4SEhP+2xNMAcIyoAHCMqJhwjKjPcIyowHCMqLFwjKijcoymlXSMpIh0jKR6co2mbG+OqGFqj61zXZO4AeXv9gCEhIT/hISE/////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wCEhIT/hISE/6i5ygDF0dwAIiozACQyPQAoP1AALlBmADhlggBblLkGVJbBPFOWwnxTlsK5U5bC9FOWwv9TlsIp3erzAISEhP+EhIT/////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAAAAAAALztHAAAAAAAuU2sAU5bCClOWwkNTlsKAU5bCwFOWwvhTlsL/U5bC/1OWwv9TlsL/U5bC/ViVvVcXOFAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AAAAAAAAAAAALDhEALVFoAFOWwjpTlsL6U5bC/1OWwv9TlsL/U5bC/1OWwvxTlsLIV5W+i2CRs0xHi71TKYzUnyuM0gIJHi4AAAAAAAAAAAAAAAAA////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wAAAAAAAAAAACtNZABTlsIAU5bCD1OWwv1TlsL6U5bCxFOWwoRVlsBHZJKwDCNObAA8icJAKYzUwimM1P8pjNT/KYzUWCaCxgALLUsAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAApS2EAU5bCAFOWwgBTlsIAU5bCNVOWwgg+cJEAIT1QABU/XQA1isg4KYzUuymM1P8pjNT/KYzU/ymM1LAti9E0JYvmDhdouAAAAAAAAAAAAP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AFyk1AE+PuQBTlsIAU5bCAER7nwAmRVoADBojABRFaQAwi80xKYzUsymM1P8pjNT/KYzU/ymM1LgsjNE2MovXFB+K9MUfivbBH4r2BgcdNAARQH8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wAAAAAAAQIDABIgKgAPGiIABRMcABdQeQAti9AqKYzUrCmM1P8pjNT/KYzU/ymM1MAqjNM9HmqmACWK7SIfivbZH4r2/x+K9vsuiudAFE2YACB69AD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAAAAAAABhQfABtejgAoitEAKYzUACmM1JQpjNT/KYzU/ymM1MgpjNREH2mgABlosQAfivY0H4r26R+K9v8fivbyKIrtR0CB1SggevTQIHr0Nv///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AAAAAAAAAAAACBwsAJX2+ACmM1AApjNQAKYzUGSmM1MYpjNRMInWxABNHdQAcfuEAH4r2Sx+K9vUfivb/H4r25iGK9DE2gt4EIHr0yyB69P8gevTQ////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wAAAAAAAAAAAAAAAAAOMUsAKYzUACmM1AApjNQAJX6/ABE7WgAUWJwAH4r2AB+K9mYfivb9H4r2/x+K9tYfivYfG27RACB69HsgevT/IHr0+yB69DL///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAAAAAAAAAAAAAAAAAAfaJ4AJ4XKABVGagAKKkoAG3raAB+K9gEfivaEH4r2/x+K9v8fivbCH4r2EB133wAgevQsIHr0+SB69P8gevSAIHr0AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AAAAAAAAAAAAAAAAAAAAAAAUSGwAFERwAElCOAB+J9QAfivYAH4r2lx+K9v8fivb/H4r2qR+K9gYefuoAIHr0BSB69M4gevT/IHr00CB69AUgevQA////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAkqSgAfivYAH4r2AB+K9gAfivZLH4r2/R+K9osfivYBH4PwACB69AAgevSAIHr0/yB69PkgevQwIHr0ACB69AD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAAAAAAAAAAAAAAAAAAAAAAAEEiAAB+K9gAfivYAH4r2AB+K9gAfivYsH4r2AB+G8wAge/QAIHr0MCB69PsgevT/IHr0eyB69AAgevQAIHr0AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAXZrYAH4r2AB+K9gAfivYAH4r2AB+K9gAfifUAIHz0ACB69AcgevTQIHr0/yB69MwgevQEIHr0ACB69AAgevQA////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wAAAAAAAAAAAAAAAAAAAAAAAAIDAB6E6gAfivYAH4r2AB+K9gAfivYAH4r2ACB+9QAgevQAIHr0fCB69P8gevT5IHr0LCB69AAgevQAIHr0ACB69AD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAAAAAAAAAAAAAAAAAABBAcAEUqDAB6E6wAfivYAH4r2AB+K9gAggPUAIHr0ACB69AAgevQTIHr0qCB69HYgevQAIHr0ACB69AAgevQAIHr0AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP////////////////wAAH/8AAB//P/+f/z//n/8wAZ//MAGf/z//n/8wAZ//MAGf/zAAn/8/gJ//+AD///AAf//wEH//+cA///8AH//8BB///BgH//xwB///4If//4EP//+CD///hh///9w////4P///+H////j////////////">
<style type="text/css" media="screen,all">
td
{
    width: 30px;
    height: 30px;
    font-size: 69%;
    text-align: right;
    padding: 2px;
}
</style>
<script type="text/javascript" src="statechanges.json"></script>
<script type="text/javascript">
<!--
function window_load()
{
    "use strict"

    var prefix = window.location.protocol === "file:" ? "https://ack.space/spaceAPI/" : "";

    var pWeek = loadStateChanges( { uri: prefix + "statechanges.php", hours: 168, description: "Last week's space state", applyCurrentState: true } );
    pWeek.then( function( _data )
    {
        // Week
        displayStateChanges( _data.states, _data.hours, _data.description, _data.currentTime, _data.currentState );

        return loadStateChanges( { uri: prefix + "statechanges.php?month=0", hours: 168 * 52 / 12, description: "Last month's space state average" } );
    } ).then( function( _data )
    {
        // Month
        displayStateChanges( _data.states, _data.hours, _data.description, _data.currentTime, _data.currentState );

        return Promise.all( [
                                _data,
                                loadStateChanges( { uri: prefix + "statechanges.php?month=1" } ),
                                loadStateChanges( { uri: prefix + "statechanges.php?month=2" } )
                            ] );
    } ).then( function( _data )
    {
        // Quarter
        displayStateChanges( [].concat.apply([], _data.map( function( _d ){ return _d.states } ) ), 168 * 52 / 4, "Last quarter's space state average" );

        return Promise.all( _data.concat(   loadStateChanges( { uri: prefix + "statechanges.php?month=3" } ),
                                            loadStateChanges( { uri: prefix + "statechanges.php?month=4" } ),
                                            loadStateChanges( { uri: prefix + "statechanges.php?month=5" } ),
                                            loadStateChanges( { uri: prefix + "statechanges.php?month=6" } ),
                                            loadStateChanges( { uri: prefix + "statechanges.php?month=7" } ),
                                            loadStateChanges( { uri: prefix + "statechanges.php?month=8" } ),
                                            loadStateChanges( { uri: prefix + "statechanges.php?month=9" } ),
                                            loadStateChanges( { uri: prefix + "statechanges.php?month=10" } ),
                                            loadStateChanges( { uri: prefix + "statechanges.php?month=11" } )
                                        ) );
    } ).then( function( _data )
    {
        // Year
        displayStateChanges( [].concat.apply([], _data.map( function( _d ){ return _d.states } ) ), 168 * 52, "Last year's space state average" );
    } );

    /*
    var xhr = new XMLHttpRequest();
    xhr.open( "GET", "statechanges.php" );
    xhr.responseType = "json";
    xhr.onload = function( _event )
    {
        var states = _event.target.response;
        displayStateChanges( states, 168, "Last week's space state", new Date( states[ states.length - 1 ].updated * 1000 ), states[ states.length - 1 ].state );
    };
    xhr.send();

    xhr = new XMLHttpRequest();
    xhr.open( "GET", "statechanges.php?month=0" );
    xhr.responseType = "json";
    xhr.onload = function( _event )
    {
        displayStateChanges( _event.target.response,  );
    };
    xhr.send();


    //displayStateChanges( statechanges );
    */
}

function loadStateChanges( _params )
{
    return new Promise( function( _resolve, _reject )
    {
        var xhr = new XMLHttpRequest();
        xhr.open( "GET", _params.uri );
        xhr.responseType = "json";
        xhr.onload = function( _event )
        {
            _params.states = _event.target.response;
            if ( _params.applyCurrentState )
            {
                _params.currentTime = new Date( _params.states[ _params.states.length - 1 ].updated * 1000 );
                _params.currentState = _params.states[ _params.states.length - 1 ].state;
            }

            _resolve( _params );
            //displayStateChanges( states, 168, "Last week's space state", new Date( states[ states.length - 1 ].updated * 1000 ), states[ states.length - 1 ].state );
        };
        xhr.onerror = function( _event )
        {
            _reject( "request error" );
        }
        xhr.send();
    } );
}

function displayStateChanges( _statechanges, _hours, _description, _currentTime, _currentState )
{
    "use strict"

    var opened = Array( 168 );
    var closed = Array( 168 );

    for ( var i = 0; i < opened.length; i++ )
    {
        opened[ i ] = closed[ i ] = 0;
    };

    var state;
    var created;
    var updated;
    var begin;
    var end;

    // Iterate _statechanges and do a bucket sort (which can span over multiple hours)
    for ( var nState = 0; nState < _statechanges.length; nState++ )
    {
        state = _statechanges[ nState ];

        created = new Date( state.created * 1000 );
        updated = new Date( state.updated * 1000 );

        var startTime = new Date( created.getFullYear(), created.getMonth(), created.getDate(), created.getHours() );
        var currentTime;
        var endTime = new Date( updated.getFullYear(), updated.getMonth(), updated.getDate(), updated.getHours() );
        var weekHour;

        for ( var time = startTime.getTime(); time <= endTime.getTime(); time += 3600000 )
        {
            currentTime = new Date( time );
            //console.log( currentTime, currentTime.getDay(), currentTime.getHours(), 24 * currentTime.getDay() + currentTime.getHours() );
            if ( time === startTime.getTime() )
                begin = created.getMinutes();
            else
                begin = 0;

            if ( time === endTime.getTime() )
                end = updated.getMinutes();
            else
                end = 60;

            weekHour = 24 * currentTime.getDay() + currentTime.getHours();
            opened[ weekHour ] += state.state ? (end - begin) : 60 - (end - begin);
            closed[ weekHour ] += state.state ? 60 - (end - begin) : (end - begin);;
        }
    }

    var noData = [];
    var ratios = opened.map( function( _v, _i )
    {
        if ( _v + this[ _i ] === 0 )
        {
            noData.push( _i );
            return 0;
        }
        return _v / (_v + this[ _i ]);
    }.bind( closed ) );

    if ( noData.length )
        console.warn( "no data for hour(s)", noData.join() );


    //addRatioTable( document.body, ratios, 168 * 52 / 12, "Last month's space state average" );
    addRatioTable( document.body, ratios, _hours, _description, _currentTime, _currentState );
}

function addRatioTable( _parent, _ratios, _totalHours, _label, _currentTime, _currentState )
{
    var weekday = [ "Su", "Mo", "Tu", "We", "Th", "Fr", "Sa" ];
    var table = _parent.appendChild( document.createElement( "table" ) );
    var tb = table.appendChild( document.createElement( "tbody" ) );
    var tr;
    var td;

    if ( _label )
    {
        tr = tb.appendChild( document.createElement( "tr" ) );
        td = tr.appendChild( document.createElement( "th" ) );
        td.colSpan = 26;
        td.textContent = _label;
    }

    tr = tb.appendChild( document.createElement( "tr" ) );
    tr.appendChild( document.createElement( "th" ) );
    for ( var h = 0; h < 24; h++ )
    {
        tr.appendChild( document.createElement( "th" ) ).textContent = h;
    }
    tr.appendChild( document.createElement( "th" ) ).textContent = "avg";

    var r,g;
    var ratio;
    var davg;
    var avg = 0;

    for ( var wd = 0; wd < 7; wd++ )
    {
        tr = tb.appendChild( document.createElement( "tr" ) );
        tr.appendChild( document.createElement( "th" ) ).textContent = weekday[ wd ];
        davg = 0;
        for ( var h = 0; h < 24; h++ )
        {
            ratio = _ratios[ 24 * wd + h ];
            davg += ratio;

            td = addCell( tr, ratio * 100 | 0 );
            if ( _currentTime && _currentTime.getDay() === wd && _currentTime.getHours() === h )
            {
                td.style.fontWeight = "bold";
                td.style.textAlign = "center";
                td.textContent = "now";
                if ( _currentState )
                {
                    td.title = "Open";
                    td.style.backgroundColor = "rgba(0,255,0,0.6)";
                }
                else
                {
                    td.title = "Closed";
                    td.style.backgroundColor = "rgba(255,0,0,0.6)";
                }
            }
        }

        davg /= 24;
        avg += davg;
        addCell( tr, ( davg * 1000 | 0 ) / 10, _totalHours / 7 );
    }
    tr = tb.appendChild( document.createElement( "tr" ) );
    tr.appendChild( document.createElement( "th" ) ).colSpan = 25;
    addCell( tr, ( avg * 1000 / 7 | 0 ) / 10, _totalHours );
}

function addCell( _tr, _percentage, _totalTime )
{
    var td = _tr.appendChild( document.createElement( "td" ) );
    td.innerText = _percentage + "%";
    td.title = secondsToTimeStamp( _percentage * 36 ) + (_totalTime ? " (" + secondsToTimeStamp( _percentage * _totalTime * 36 ) + " total)" : "");

    if ( _percentage > 50 )
    {
        r = 255 - (_percentage - 50) * 5.12 | 0;
        g = 255;
    }
    else
    {
        r = 255;
        g = _percentage * 5.12 | 0;
    }
    td.style.backgroundColor = "rgba("+r+","+g+",0,0.6)";
    return td;
}

function secondsToTimeStamp( _time )
{
    var factors = [ 60, 60, 24 ];
    var separators = [ ":", ":", "d " ];
    var timestamp = "";

    while ( factors.length && _time >= factors[ 0 ] )
    {
        timestamp = separators.shift() + ("0" + (_time % factors[ 0 ] | 0)).substr( -2 ) + timestamp;
        _time /= factors.shift();
    }

    timestamp = (_time | 0 ) + timestamp;
    return timestamp;
}

function $( _o )
{
    return document.querySelector( "#" + _o );
    //return document.getElementById( _o );
}

window.addEventListener( "load", window_load, false );
//-->
</script>

</head>

<body>
.

</body>
</html>